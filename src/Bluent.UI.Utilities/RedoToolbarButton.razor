@using Bluent.Core
@using Bluent.UI.Components
@implements IDisposable

<ToolbarButton Text="@Text"
               Tooltip="@Tooltip"
               Icon="icon-ic_fluent_arrow_redo_20_regular"
               ActiveIcon="icon-ic_fluent_arrow_redo_20_filled"
               OnClick="Execute"
               disabled="@(!CanExecute)"/>

@code {
    private CommandManager? _commandManager;

    [Parameter] public string? Text { get; set; }
    [Parameter] public string? Tooltip { get; set; }
    [Parameter, EditorRequired] public CommandManager? CommandManager { get; set; }

    private bool CanExecute => _commandManager?.CanRedo ?? false;

    protected override void OnParametersSet()
    {
        InitializeCommandManager();

        base.OnParametersSet();
    }

    private void InitializeCommandManager()
    {
        if (_commandManager != CommandManager)
        {
            UnsetEvents();
            _commandManager = CommandManager;
            SetEvents();
        }
    }

    public void Dispose()
    {
        UnsetEvents();
    }

    private void SetEvents()
    {
        if (_commandManager is null)
            return;

        _commandManager.CommandExecuted += OnCommandExecuted;
    }

    private void UnsetEvents()
    {
        if (_commandManager is null)
            return;

        _commandManager.CommandExecuted -= OnCommandExecuted;
    }

    private void OnCommandExecuted(object? sender, EventArgs e)
    {
        StateHasChanged();
    }

    private void Execute()
    {
        _commandManager?.Redo();
    }
}